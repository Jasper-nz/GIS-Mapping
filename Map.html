<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Map Visualization</title>

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>

    <!-- Neo4j -->
    <script src="https://unpkg.com/neo4j-driver"></script>

    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0;
      }
      
      .legend {
        position: absolute;
        bottom: 20px;
        right: 10px;
        background: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
        font-family: Arial, sans-serif;
        max-width: 250px;
      }
      
      .legend h3 {
        margin: 0 0 10px 0;
        font-size: 16px;
      }
      
      .legend-item {
        display: flex;
        align-items: center;
        margin: 8px 0;
        cursor: pointer;
      }
      
      .legend-item input[type="checkbox"] {
        margin-right: 8px;
      }
      
      .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        border: 1px solid #333;
        border-radius: 3px;
      }
      
      .legend-label {
        font-size: 14px;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
	
	<div class="legend">
      <h3>Legend</h3>
      
      <label class="legend-item">
        <input type="checkbox" id="consentToggle" checked>
        <div class="legend-color" style="background-color: #ef4444; border-radius: 50%;"></div>
        <span class="legend-label">Consents</span>
      </label>
      
      <label class="legend-item">
        <input type="checkbox" id="parcelToggle" checked>
        <div class="legend-color" style="background-color: #86efac;"></div>
        <span class="legend-label">Parcels</span>
      </label>
      
      <label class="legend-item">
        <input type="checkbox" id="irrigationToggle" checked>
        <div class="legend-color" style="background-color: #3b82f6;"></div>
        <span class="legend-label">Irrigation</span>
      </label>
      
      <label class="legend-item">
        <input type="checkbox" id="soilToggle" checked>
        <div class="legend-color" style="background-color: #d97706;"></div>
        <span class="legend-label">Soil</span>
      </label>
    </div>

    <script>
      /* ===============================
         Neo4j connection
      =============================== */
      const driver = neo4j.driver(
        "neo4j://localhost",
        neo4j.auth.basic("neo4j", "12345678")
      );

      driver
        .verifyConnectivity()
        .then(() => console.log("âœ… Connected to Neo4j"))
        .catch(console.error);

      /* ===============================
         Map setup
      =============================== */
      const map = L.map("map").setView([-43.58, 172.15], 11);

      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap",
      }).addTo(map);

      /* ===============================
         Consent layer
      =============================== */
      const consentLayer = L.layerGroup().addTo(map);

      /* ===============================
         Parcel layer
      =============================== */
      const parcelLayer = L.geoJSON(null, {
        style: {
          color: "#16a34a",      // border
          fillColor: "#86efac",  // fill
          weight: 1,
          fillOpacity: 0.35,
        },
        onEachFeature: (feature, layer) => {
          layer.bindPopup(
            `<b>Parcel</b><br>ID: ${feature.properties.id}`
          );

          // Optional hover highlight
          layer.on({
            mouseover: () => layer.setStyle({ weight: 3 }),
            mouseout: () => layer.setStyle({ weight: 1 }),
          });
        },
      }).addTo(map);
	  
	  /* ===============================
         Irrigation layer
      =============================== */
      const irrigationLayer = L.geoJSON(null, {
        style: {
          color: "#1e40af",
          fillColor: "#3b82f6",
          weight: 2,
          fillOpacity: 0.4,
        },
        onEachFeature: (feature, layer) => {
          const props = feature.properties;
          layer.bindPopup(
            `<b>Irrigation</b><br>
             <b>Type:</b> ${props.Type || "N/A"}<br>
             <b>Area(ha):</b> ${props.Area_ha || "N/A"}<br>
             <b>Year_Irrigated:</b> ${props.Year_irr || "N/A"}<br>
             <b>Status:</b> ${props.Status || "N/A"}<br>
             <b>Confidence:</b> ${props.Confidence || "N/A"}<br>
             <b>Notes:</b> ${props.Notes || "N/A"}`
          );

          layer.on({
            mouseover: () => layer.setStyle({ weight: 3 }),
            mouseout: () => layer.setStyle({ weight: 2 }),
          });
        },
      }).addTo(map);
	  
	   /* ===============================
         Soil layer
      =============================== */
      const soilLayer = L.geoJSON(null, {
        style: {
          color: "#92400e",
          fillColor: "#d97706",
          weight: 1,
          fillOpacity: 0.3,
        },
        onEachFeature: (feature, layer) => {
          const props = feature.properties;
          layer.bindPopup(
            `<b>Soil</b><br>
             <b>Name:</b> ${props.Soil_name || "N/A"}<br>
             <b>Series:</b> ${props.Series || "N/A"}<br>
             <b>Type:</b> ${props.Type || "N/A"}<br>
             <b>Texture:</b> ${props.Texture || "N/A"}<br>
             <b>Slope:</b> ${props.Slope || "N/A"}<br>
             <b>Subgroup:</b> ${props.Subgroup || "N/A"}<br>
             <b>Group:</b> ${props.Group || "N/A"}<br>
             <b>Order:</b> ${props.Order || "N/A"}`
          );

          layer.on({
            mouseover: () => layer.setStyle({ weight: 3 }),
            mouseout: () => layer.setStyle({ weight: 1 }),
          });
        },
      }).addTo(map);


      /* ===============================
         Load consent locations
      =============================== */
      function loadConsents() {
        const cypher = `
          MATCH (c:Selwyn_Consent)
          RETURN 
                 c.consentNo AS consentNo,
                 c.type AS type,
                 c.status AS status,
                 c.holderName AS holderName,
                 c.activityText AS activity,
                 c.location AS location
        `;

        const session = driver.session();

        session
          .run(cypher)
          .then((result) => {
            result.records.forEach((record) => {
              const loc = record.get("location");

              const lat = loc.y;
              const lon = loc.x;

              L.circleMarker([lat, lon], {
                radius: 6,
                color: "#991b1b",
                fillColor: "#ef4444",
                fillOpacity: 0.9,
				weight:2
              })
                .addTo(consentLayer)
                .bindPopup(
                  `<b>Consent</b><br>
             	   <b>Consent No:</b> ${record.get("consentNo") || "N/A"}<br>
                   <b>Type:</b> ${record.get("type") || "N/A"}<br>
                   <b>Status:</b> ${record.get("status") || "N/A"}<br>
                   <b>Holder:</b> ${record.get("holderName") || "N/A"}<br>
                   <b>Activity:</b> ${record.get("activity") || "N/A"}`
                );
            });
          })
          .catch(console.error)
          .then(() => session.close());
      }

      /* ===============================
         Load parcel polygons
      =============================== */
      function loadParcels() {
        const cypher = `
          MATCH (p:Selwyn_Parcel)
          RETURN p.id AS id,
                 p.geom AS geom
        `;

        const session = driver.session();

        session
          .run(cypher)
          .then((result) => {
            result.records.forEach((record) => {
              const geom = JSON.parse(record.get("geom"));

              const parcelFeature = {
                type: "Feature",
                geometry: geom,
                properties: {
                  id: record.get("id"),
                },
              };

              parcelLayer.addData(parcelFeature);
            });
          })
          .catch(console.error)
          .then(() => session.close());
      }
	  
	  /* ===============================
         Load irrigation polygons
      =============================== */
      function loadIrrigation() {
        const cypher = `
          MATCH (i:Selwyn_Irrigation)
          RETURN i.Type AS Type,
                 i.Notes AS Notes,
                 i.Area_ha AS Area_ha,
                 i.Year_irr AS Year_irr,
                 i.Year_Mapped AS Year_Mapped,
                 i.Status AS Status,
                 i.Confidence AS Confidence,
                 i.Region AS Region,
                 i.geom AS geom
        `;

        const session = driver.session();

        session
          .run(cypher)
          .then((result) => {
            result.records.forEach((record) => {
              const geom = JSON.parse(record.get("geom"));

              const irrigationFeature = {
                type: "Feature",
                geometry: geom,
                properties: {
                  Type: record.get("Type"),
                  Notes: record.get("Notes"),
                  Area_ha: record.get("Area_ha"),
                  Year_irr: record.get("Year_irr"),
                  Year_Mapped: record.get("Year_Mapped"),
                  Status: record.get("Status"),
                  Confidence: record.get("Confidence"),
                  Region: record.get("Region"),
                },
              };

              irrigationLayer.addData(irrigationFeature);
            });
          })
          .catch(console.error)
          .then(() => session.close());
      }
	  
	  /* ===============================
         Load soil polygons
      =============================== */
      function loadSoil() {
        const cypher = `
          MATCH (s:Selwyn_Soil)
          RETURN s.Series AS Series,
                 s.Type AS Type,
                 s.Texture AS Texture,
                 s.Phase AS Phase,
                 s.Slope AS Slope,
                 s.Soil_name AS Soil_name,
                 s.Code AS Code,
                 s.Subgroup AS Subgroup,
                 s.Group AS Group,
                 s.Order AS Order,
                 s.geom AS geom
        `;

        const session = driver.session();

        session
          .run(cypher)
          .then((result) => {
            result.records.forEach((record) => {
              const geom = JSON.parse(record.get("geom"));

              const soilFeature = {
                type: "Feature",
                geometry: geom,
                properties: {
                  Series: record.get("Series"),
                  Type: record.get("Type"),
                  Texture: record.get("Texture"),
                  Phase: record.get("Phase"),
                  Slope: record.get("Slope"),
                  Soil_name: record.get("Soil_name"),
                  Code: record.get("Code"),
                  Subgroup: record.get("Subgroup"),
                  Group: record.get("Group"),
                  Order: record.get("Order"),
                },
              };

              soilLayer.addData(soilFeature);
            });
          })
          .catch(console.error)
          .then(() => session.close());
      }

      /* ===============================
         Load everything
      =============================== */
      loadConsents();
      loadParcels();
	  loadIrrigation();
	  loadSoil();
	  
	  /* ===============================
         Layer toggle controls
      =============================== */
      document.getElementById("consentToggle").addEventListener("change", (e) => {
        if (e.target.checked) {
          map.addLayer(consentLayer);
        } else {
          map.removeLayer(consentLayer);
        }
      });

      document.getElementById("parcelToggle").addEventListener("change", (e) => {
        if (e.target.checked) {
          map.addLayer(parcelLayer);
        } else {
          map.removeLayer(parcelLayer);
        }
      });

      document.getElementById("irrigationToggle").addEventListener("change", (e) => {
        if (e.target.checked) {
          map.addLayer(irrigationLayer);
        } else {
          map.removeLayer(irrigationLayer);
        }
      });

      document.getElementById("soilToggle").addEventListener("change", (e) => {
        if (e.target.checked) {
          map.addLayer(soilLayer);
        } else {
          map.removeLayer(soilLayer);
        }
      });
    </script>
  </body>
</html>
